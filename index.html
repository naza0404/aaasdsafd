<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Platforma Za≈Çadunku i Roz≈Çadunku</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    .pilne {
      background-color: #ffe6e6;
    }
    .status-aktualne {
      background-color: #a5f3a1 !important;
      font-weight: bold;
    }
    .status-nieaktualne {
      background-color: #f9a1a1 !important;
      font-weight: bold;
    }
    .status-nieznane {
      background-color: #fff7a1 !important;
      font-weight: bold;
    }
    .date-time-group input {
      width: 45%;
      display: inline-block;
      margin: 2px 1%;
    }
    textarea {
      width: 100%;
      height: 60px;
      resize: vertical;
    }
    input[list] {
      width: 100%;
    }
    #map {
      height: 400px;
      margin-top: 30px;
    }
    #truck-ban-widget {
      margin: 20px 0;
      text-align: center;
    }
  </style>
</head>
<body>

  <h1>Platforma Za≈Çadunku i Roz≈Çadunku</h1>

  <div id="truck-ban-widget">
    <iframe src="https://trafficban.com/plugins/box.html?language=pl" width="100%" height="300" frameborder="0"></iframe>
  </div>

  <button onclick="dodajWiersz()">‚ûï Dodaj nowy wiersz</button>
  <button onclick="sortujTabele()">‚áÖ Sortuj wed≈Çug daty</button>

  <datalist id="lokalizacje"></datalist>

  <table id="tabela">
    <thead>
      <tr>
        <th>PILNE</th>
        <th>Za≈Çadunek</th>
        <th>Data za≈Çadunku (od-do)</th>
        <th>Godzina za≈Çadunku (od-do)</th>
        <th>Roz≈Çadunek</th>
        <th>Data roz≈Çadunku (od-do)</th>
        <th>Godzina roz≈Çadunku (od-do)</th>
        <th>Spos√≥b za≈Çadunku</th>
        <th>Potwierd≈∫ aktualno≈õƒá</th>
        <th>Uwagi</th>
        <th>Stawka</th>
        <th>Mapka</th>
        <th>Akcje</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Mapa orientacyjna</h2>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    const tabela = document.getElementById("tabela").getElementsByTagName("tbody")[0];

    const map = L.map('map').setView([52.2297, 21.0122], 6); // Warszawa, Polska
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap',
      maxZoom: 18
    }).addTo(map);
    let dynamicMarker = null;

    function dodajWiersz() {
      const wiersz = tabela.insertRow();
      wiersz.classList.add("pilne");

      wiersz.innerHTML = `
        <td><input type="checkbox" checked onclick="togglePilne(this)"></td>
        <td><input type="text" list="lokalizacje" placeholder="Kod + miasto, kraj"></td>
        <td class="date-time-group"><input type="date"> <input type="date"></td>
        <td class="date-time-group"><input type="time"> <input type="time"></td>
        <td><input type="text" list="lokalizacje" placeholder="Kod + miasto, kraj"></td>
        <td class="date-time-group"><input type="date"> <input type="date"></td>
        <td class="date-time-group"><input type="time"> <input type="time"></td>
        <td>
          <select>
            <option value="ty≈Çem">Ty≈Çem</option>
            <option value="bokiem">Bokiem</option>
            <option value="g√≥rƒÖ">G√≥rƒÖ</option>
            <option value="bok_g√≥ra">Bok + G√≥ra</option>
            <option value="auto_winda">Auto z windƒÖ</option>
            <option value="inne">Inne</option>
          </select>
        </td>
        <td>
          <select onchange="zmienAktualnosc(this)">
            <option value="">-- wybierz --</option>
            <option value="aktualne">Aktualne</option>
            <option value="nieaktualne">Nieaktualne</option>
            <option value="nieznane">???</option>
          </select>
        </td>
        <td><textarea placeholder="Uwagi"></textarea></td>
        <td><input type="text" placeholder="Stawka"></td>
        <td><input type="checkbox" onchange="pokazNaMapie(this)"></td>
        <td><button onclick="usunWiersz(this)">üóëÔ∏è Usu≈Ñ</button></td>
      `;
    }

    function usunWiersz(button) {
      if (confirm("Czy na pewno chcesz usunƒÖƒá ten wiersz?")) {
        const wiersz = button.closest("tr");
        tabela.deleteRow(wiersz.rowIndex - 1);
      }
    }

    function zmienAktualnosc(select) {
      const td = select.parentNode;
      td.classList.remove("status-aktualne", "status-nieaktualne", "status-nieznane");
      if (select.value === "aktualne") td.classList.add("status-aktualne");
      else if (select.value === "nieaktualne") td.classList.add("status-nieaktualne");
      else if (select.value === "nieznane") td.classList.add("status-nieznane");
    }

    function togglePilne(checkbox) {
      const wiersz = checkbox.closest("tr");
      wiersz.classList.toggle("pilne", checkbox.checked);
      const tbody = tabela;
      tbody.removeChild(wiersz);
      checkbox.checked ? tbody.insertBefore(wiersz, tbody.firstChild) : tbody.appendChild(wiersz);
    }

    function sortujTabele() {
      const wiersze = Array.from(tabela.rows);
      wiersze.sort((a, b) => {
        const dataA = new Date(a.cells[2].querySelector("input").value);
        const dataB = new Date(b.cells[2].querySelector("input").value);
        return dataA - dataB;
      });
      wiersze.forEach(wiersz => tabela.appendChild(wiersz));
    }

    function pokazNaMapie(checkbox) {
      if (!checkbox.checked) return;
      const wiersz = checkbox.closest("tr");
      const ladunek = wiersz.cells[1].querySelector("input").value;
      const rozladunek = wiersz.cells[4].querySelector("input").value;

      const miejsce = ladunek || rozladunek;
      if (miejsce) {
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(miejsce)}`)
          .then(res => res.json())
          .then(data => {
            if (data && data[0]) {
              const lat = parseFloat(data[0].lat);
              const lon = parseFloat(data[0].lon);
              if (dynamicMarker) map.removeLayer(dynamicMarker);
              dynamicMarker = L.marker([lat, lon]).addTo(map).bindPopup(miejsce).openPopup();
              map.setView([lat, lon], 10);
            }
          });
      }
    }

    fetch("polska_miejscowosci_kody.json")
      .then(response => response.json())
      .then(data => {
        const datalist = document.getElementById("lokalizacje");
        data.forEach(entry => {
          const label = `${entry.postal_code} ${entry.place_name}`.trim();
          const option = document.createElement("option");
          option.value = label;
          datalist.appendChild(option);
        });
      })
      .catch(error => console.error("B≈ÇƒÖd podczas ≈Çadowania lokalizacji z Polski:", error));
  </script>

</body>
</html>
