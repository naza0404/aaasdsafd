<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Platforma Za≈Çadunku i Roz≈Çadunku</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <style>
    body { font-family: Arial, sans-serif; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    .pilne { background-color: #ffe6e6; }
    .status-aktualne { background-color: #a5f3a1 !important; font-weight: bold; }
    .status-nieaktualne { background-color: #f9a1a1 !important; font-weight: bold; }
    .status-nieznane { background-color: #fff7a1 !important; font-weight: bold; }
    .date-time-group input {
      width: 45%;
      display: inline-block;
      margin: 2px 1%;
    }
    textarea { width: 100%; height: 60px; resize: vertical; }
    input[list], input[type="text"] { width: 100%; }
    #mapa { width: 100%; height: 500px; margin-top: 20px; }
  </style>
</head>
<body>

<h1>Platforma Za≈Çadunku i Roz≈Çadunku</h1>
<button onclick="dodajWiersz()">‚ûï Dodaj nowy wiersz</button>
<datalist id="lokalizacje"></datalist>

<table id="tabela">
  <thead>
    <tr>
      <th>PILNE</th>
      <th>Za≈Çadunek</th>
      <th>Data za≈Çadunku (od-do)</th>
      <th>Godzina za≈Çadunku (od-do)</th>
      <th>Roz≈Çadunek</th>
      <th>Data roz≈Çadunku (od-do)</th>
      <th>Godzina roz≈Çadunku (od-do)</th>
      <th>Spos√≥b za≈Çadunku</th>
      <th>Potwierd≈∫ aktualno≈õƒá</th>
      <th>Uwagi</th>
      <th>Stawka</th>
      <th>Kilometry</th>
      <th>Stawka z km</th>
      <th>Mapka</th>
      <th>Akcje</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="mapa"></div>

<script>
function dodajWiersz() {
  const tabela = document.getElementById("tabela").getElementsByTagName("tbody")[0];
  const wiersz = tabela.insertRow();
  wiersz.classList.add("pilne");
  wiersz.innerHTML = `
    <td><input type="checkbox" checked onclick="togglePilne(this)"></td>
    <td><input type="text" list="lokalizacje" placeholder="Kod + miasto, kraj"></td>
    <td class="date-time-group"><input type="date"> <input type="date"></td>
    <td class="date-time-group"><input type="time"> <input type="time"></td>
    <td><input type="text" list="lokalizacje" placeholder="Kod + miasto, kraj"></td>
    <td class="date-time-group"><input type="date"> <input type="date"></td>
    <td class="date-time-group"><input type="time"> <input type="time"></td>
    <td>
      <select>
        <option value="ty≈Çem">Ty≈Çem</option>
        <option value="bokiem">Bokiem</option>
        <option value="g√≥rƒÖ">G√≥rƒÖ</option>
        <option value="bok_g√≥ra">Bok + G√≥ra</option>
        <option value="auto_winda">Auto z windƒÖ</option>
        <option value="inne">Inne</option>
      </select>
    </td>
    <td>
      <select onchange="zmienAktualnosc(this)">
        <option value="">-- wybierz --</option>
        <option value="aktualne">Aktualne</option>
        <option value="nieaktualne">Nieaktualne</option>
        <option value="nieznane">???</option>
      </select>
    </td>
    <td><textarea placeholder="Uwagi"></textarea></td>
    <td><input type="text" placeholder="Stawka"></td>
    <td><input type="text" placeholder="km"></td>
    <td><input type="text" placeholder="z≈Ç/km"></td>
    <td><input type="checkbox" onchange="pokazNaMapie(this)"></td>
    <td><button onclick="usunWiersz(this)">üóëÔ∏è Usu≈Ñ</button></td>
  `;
}

function togglePilne(checkbox) {
  const wiersz = checkbox.closest("tr");
  wiersz.classList.toggle("pilne", checkbox.checked);
  const tbody = document.getElementById("tabela").getElementsByTagName("tbody")[0];
  tbody.removeChild(wiersz);
  checkbox.checked ? tbody.insertBefore(wiersz, tbody.firstChild) : tbody.appendChild(wiersz);
}

function usunWiersz(button) {
  if (confirm("Czy na pewno chcesz usunƒÖƒá ten wiersz?")) {
    const wiersz = button.closest("tr");
    wiersz.remove();
  }
}

function zmienAktualnosc(select) {
  const td = select.parentNode;
  td.classList.remove("status-aktualne", "status-nieaktualne", "status-nieznane");
  if (select.value === "aktualne") td.classList.add("status-aktualne");
  else if (select.value === "nieaktualne") td.classList.add("status-nieaktualne");
  else if (select.value === "nieznane") td.classList.add("status-nieznane");
}

let mapa;

function pokazNaMapie(checkbox) {
  if (!checkbox.checked) return;

  const wiersz = checkbox.closest("tr");
  const ladunek = wiersz.cells[1].querySelector("input").value.split(" ").slice(1).join(" ");
  const rozladunek = wiersz.cells[4].querySelector("input").value.split(" ").slice(1).join(" ");

  if (!ladunek || !rozladunek) {
    alert("Wprowad≈∫ miejsca za≈Çadunku i roz≈Çadunku.");
    return;
  }

  if (!mapa) {
    mapa = L.map('mapa').setView([52.1, 19.3], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Mapy ¬© OpenStreetMap'
    }).addTo(mapa);
  }

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${ladunek}`)
    .then(res => res.json())
    .then(data1 => {
      const lat1 = data1[0].lat, lon1 = data1[0].lon;
      return fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${rozladunek}`)
        .then(res => res.json())
        .then(data2 => {
          const lat2 = data2[0].lat, lon2 = data2[0].lon;
          mapa.setView([(parseFloat(lat1)+parseFloat(lat2))/2, (parseFloat(lon1)+parseFloat(lon2))/2], 7);
          L.marker([lat1, lon1]).addTo(mapa).bindPopup("Za≈Çadunek").openPopup();
          L.marker([lat2, lon2]).addTo(mapa).bindPopup("Roz≈Çadunek").openPopup();
          L.polyline([[lat1, lon1], [lat2, lon2]], {color: 'blue'}).addTo(mapa);
          const dystans = obliczOdleglosc(parseFloat(lat1), parseFloat(lon1), parseFloat(lat2), parseFloat(lon2));
          wiersz.cells[11].querySelector("input").value = dystans.toFixed(1);
        });
    });
}

function obliczOdleglosc(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}
</script>

</body>
</html>
